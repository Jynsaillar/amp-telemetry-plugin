<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- In production, instead of referencing 'latest', always use a specific version of the AMP player, as mentioned here: -->
    <!-- https://docs.microsoft.com/en-us/azure/media-services/azure-media-player/azure-media-player-full-setup -->
    <link href="//amp.azure.net/libs/amp/2.3.10/skins/amp-default/azuremediaplayer.min.css" rel="stylesheet">
    <script src="//amp.azure.net/libs/amp/2.3.10/azuremediaplayer.min.js"></script>
    <script>
        (function () {
            amp.plugin('telemetry', function (options) {

                var player = this

                var init = function () {
                    console.log("plugin telemetry initialized with player ", player)
                }

                // initialize the plugin
                init();

                // For debugging - whether the Object.keys(...) reflection flood of information should be posted to the console.
                var debugReflection = false;

                // Number of bitrate changes (counter).
                var bitrateChanges = 0;

                // Player dimensions.
                var pWidth = 0;
                var pHeight = 0;

                // Figuring out which AMP event listeners exist in the first place and how to access them.
                // List of events taken from here:
                // https://github.com/Azure-Samples/azure-media-player-samples/blob/master/typescript/azuremediaplayer.d.ts
                player.addEventListener(amp.eventName.downloadbitratechanged, function () {
                    console.log("downloadbitratechanged");
                    bitrateChanges++;
                    console.log(`Total number of bitrate changes so far: ${bitrateChanges}`);

                    var currentDownloadBitrate = player.currentDownloadBitrate();
                    console.log(`Selected bitrate: ${currentDownloadBitrate}`);

                    // Null check active player stream.
                    var stream = player.currentVideoStreamList().streams ? player.currentVideoStreamList().streams[0] : undefined;
                    if (stream) {

                        var streamTracks = stream._commonStream._tracks;

                        var pWidth = player.width();
                        var pHeight = player.height();
                        console.log(`New player dimensions: ${pWidth}x${pHeight}`);

                        var trackWidth = 0;
                        var trackHeight = 0;
                        for (i = 0; i < streamTracks.length; i++) {
                            if (!(streamTracks[i]._bitrate == currentDownloadBitrate)) {
                                // Reduce nesting by checking for negated condition
                                continue;
                            }

                            trackWidth = streamTracks[i]._width;
                            trackHeight = streamTracks[i]._height;
                            console.log(`Found matching bitrate: ${currentDownloadBitrate} with width ${trackWidth}, height ${trackHeight}`);

                            if (trackWidth < pWidth || trackHeight < pHeight) {
                                console.log(`[WARNING] HIGHEST_BITRATE_POSSIBLE is false; The selected bitrate is intended for a smaller player frame size!`);
                            }
                        }
                    }
                });

                // Listen on metadata state to extract stream frame sizes/available bitrates *after* they're available.
                // TODO: Current frame size should be readable from UI (DOM), player metadata or active stream tracks? Ask on Monday which.
                player.addEventListener(amp.eventName.loadedmetadata, function () {
                    console.log("loadedmetadata");
                    // Beware that (...).streams array might be null/undefined, see here for elegant solution (view source):
                    // https://amp.azure.net/libs/amp/latest/samples/dynamic_selectBitrate.html
                    // TODO: Implement null check above.
                    if (debugReflection) {
                        console.log(Object.keys(player.currentVideoStreamList().streams[0]._commonStream._tracks));
                        console.log(player.currentVideoStreamList().streams[0]._commonStream._tracks.length);
                        player.currentVideoStreamList().streams[0]._commonStream._tracks.forEach(console.log);
                    }
                });

                if (debugReflection) {
                    console.log(Object.keys(amp.eventName));
                }
            });
        }).call(this);

    </script>
</head>

<body>

    <video id="vid1" class="azuremediaplayer amp-default-skin" width="640" height="400">
        <p class="amp-no-js">
            To view this video please enable JavaScript, and consider upgrading to a web browser that supports HTML5
            video
        </p>
    </video>
    <script>
        var myPlayer = amp('vid1', {
            /* Options */
            "nativeControlsForTouch": false,
            autoplay: true,
            controls: true,
            width: "640",
            height: "400",
            techOrder: ['AzureHtml5JS'],
            plugins: {
                /* load our telemetry plugin */
                telemetry: {
                    /* Options */
                }
            }
        }, function () {
            console.log('Good to go!');

        }
        );

        myPlayer.src([{
            src: "https://amssamples.streaming.mediaservices.windows.net/91492735-c523-432b-ba01-faba6c2206a2/AzureMediaServicesPromo.ism/manifest(format=mpd-time-csf)",
            type: "application/dash+xml"
        }]);
    </script>

</body>

</html>